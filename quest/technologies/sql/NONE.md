# N＋1問題の対策ができる

## 1. N+1問題

N+1問題とは何か、SQL 初心者にわかるように説明してください。

```
X(twitter)の例
ユーザーテーブルとツイートテーブルがあったとする。
ツイートと、ツイートした人の名前を一覧で表示したい。
まずツイートの一覧を取得する。
さらに、ツイートに紐づいているユーザーをユーザーテーブルから取得することになる。
ツイートの数が増えれば増えるほど、ユーザーテーブルから取得する回数が増える。
ツイートを全件取得するのに1回、ユーザー情報を取得するのにツイートの数N回、
合計でN+1回、クエリを実行することになる。
これが、N+1問題。

処理の流れとしては、ツイートの全件を取得するクエリのなかで、ツイートの数だけユーザー情報を取得するクエリが発生する。
ツイート取得クエリ each {
  このツイートのユーザー情報を取得
}
みたいなイメージ。
```

## 2. N+1問題対策

N+1問題に対してどのような対策があるか、主要な対策を説明してください。

N+1問題はアプリケーションを作成しているとよく問題として発生します。今後アプリケーションを開発する際に、N+1問題を引き起こさないように注意してください。

```
・JOIN句で結合する
・Eager loadingを使う

の２つ。
JOINは先に結合したテーブルを作成しておき、そこからデータを取得する方法。
Eager loadingはツイッターの例で言うと、ツイートを取得する。取得したツイートのユーザーIDをリスト化しておく。このリストをもとにユーザー情報を取得する。

```

Railsの場合、`bullet`というgemを使用することで、N+1問題が発生しているビューが表示されたときに、ポップアップで知らせてくれる。

Rails
親と子テーブルが１：多や多：多の関係の時はpreload（LEFT OUTER JOIN）
親と子テーブルが多：１の場合や関連先のテーブルの要素で絞り込みを行う場合はeager_load

ちなみに、includesメソッドは、条件によって挙動が変わり、パッと見でどのような挙動をするかわかりにくいため使用しない方が良い。
