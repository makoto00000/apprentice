# 同時実行制御について説明できる


## 1. 同時実行制御

トランザクションの重要な役割の一つに、同時実行制御(排他制御)があります。

同時実行制御とは何か、何のためにあるものかを、データベース初心者にわかるように説明してください。

```
データベースは、一般的に複数人のユーザ(処理)が同時にアクセスし、共有して使われる。
お互いが干渉せずにトランザクションを実行するためにはどうすれば良いかを考えるのが同時実行制御。

```

## 2. ACID 特性

トランザクションが必要とする特性に、ACID 特性があります。ACID 特性について、データベース初心者にわかるように説明してください。

```
Atomicity（原子性）、Consistency（一貫性）、Isolation（独立性）、Durability（永続性）の頭文字。
「一連の処理は全部やるか全部やらないかのどっちかにしてね！（Atomicity：原子性）」
「データの状態に矛盾が出ないようにしてね！（Consistency：一貫性）」
「処理途中の状態が他に影響しないようにしてね！（Isolation：独立性）」
「処理が完了したら、その状態をずーっと保持してね！（Durability：永続性）」
```

## 3. ロック

同時実行制御を行うための主要な方法がロックです。ロックとは何か、どのようにして同時実行制御を実現するかを、データベース初心者にわかるように説明してください。

```
あるデータに対する更新処理を制御するための仕組み。ロックをかけられたデータが他のトランザクションから変更できないようにする機能。言い換えれば、変更できるトランザクションを1つまでに制限する機能。
```

## 4. ロックの確認

ロックの挙動を確認しましょう。

ターミナルを2つ開き、両方とも employees データベースに接続してください。

片方のターミナル（ターミナル1）で、トランザクションを開始してください。給与テーブルに対して、従業員番号が10001で、開始日が1986-06-26の従業員の給与を70000に更新してください。

```sql
# ターミナル1
mysql> BEGIN;
mysql> UPDATE salaries SET salary = 70000 WHERE emp_no = 10001 AND from_date = '1986-06-26';
```

もう片方のターミナル（ターミナル2）で、給与テーブルに対して、従業員番号が10001で、開始日が1986-06-26の従業員の給与を2倍に更新してください。こちらのターミナルはクエリを実行されたまま停止することを確認してください。

```sql
# ターミナル2
mysql> UPDATE salaries SET salary = salary * 2 WHERE emp_no = 10001 AND from_date = '1986-06-26';
```

ターミナル1で、従業員番号が10001で、開始日が1986-06-26の従業員の給与を検索してください。給与が70000のままロックされていることを確認しましょう。

ターミナル1で、コミットをします。

``` sql
mysql> SELECT * FROM salaries WHERE emp_no = 10001 AND from_date = '1986-06-26';
mysql> COMMIT;
```

+--------+--------+------------+------------+
| emp_no | salary | from_date  | to_date    |
+--------+--------+------------+------------+
|  10001 |  70000 | 1986-06-26 | 1987-06-26 |
+--------+--------+------------+------------+
1 row in set (0.00 sec)


ターミナル2を開いてください。クエリが実行されているはずです。ターミナル2から従業員番号が10001で、開始日が1986-06-26の従業員の給与を検索してください。給与が2倍に更新されているはずです。

``` sql
mysql> SELECT * FROM salaries WHERE emp_no = 10001 AND from_date = '1986-06-26';
```

ターミナル1のコミットが終わったら、クエリが実行される。
+--------+--------+------------+------------+
| emp_no | salary | from_date  | to_date    |
+--------+--------+------------+------------+
|  10001 | 140000 | 1986-06-26 | 1987-06-26 |
+--------+--------+------------+------------+
1 row in set (0.00 sec)


これがロックの基本の挙動です。他にもクエリを色々試してみて、ロックの挙動を確認してみてください。


これで、タイムアウトの時間を確認できる。デフォルトは50秒。
```sql
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
```